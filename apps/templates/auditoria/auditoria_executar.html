{% extends 'layouts/base.html' %}

{% block title %}Executar Auditoria - ERP{% endblock %}

{% block conteudo %}
<div class="content">
    <div class="page-header">
        <h1>Executar Auditoria: {{ auditoria.titulo }}</h1>
        <div class="filter-buttons">
            <a href="{% url 'auditoria:auditoria_detail' auditoria.pk %}" class="btn btn-secondary">Voltar</a>
        </div>
    </div>

    <!-- Informações da Auditoria -->
    <div class="detail-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h2>{{ auditoria.localizacao.nome }}</h2>
                <p style="color: #666; margin: 5px 0;">
                    Responsável: {{ auditoria.responsavel.get_full_name|default:auditoria.responsavel.username }}
                </p>
            </div>
            <div style="text-align: right;">
                <h3 style="color: #1a73e8; margin: 0;">{{ progresso }}%</h3>
                <p style="margin: 5px 0;">{{ auditoria.ativos_verificados }}/{{ auditoria.total_ativos }} verificados</p>
                <div style="width: 200px; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden;">
                    <div style="width: {{ progresso }}%; height: 100%; background: #4CAF50; transition: width 0.3s;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner de Código de Barras -->
    <div class="detail-card">
        <h2><i class="bi bi-upc-scan"></i> Scanner de Código de Barras</h2>
        <form method="get" id="scannerForm" style="margin-top: 20px;">
            <div style="display: flex; gap: 10px; align-items: end;">
                <div class="form-group" style="flex: 1; margin: 0;">
                    <label for="codigo">Bipe ou digite o código do ativo:</label>
                    <input 
                        type="text" 
                        name="codigo" 
                        id="codigo" 
                        class="form-control" 
                        placeholder="Código de barras / Etiqueta"
                        autofocus
                        style="font-size: 18px; padding: 15px;"
                    >
                </div>
                <button type="submit" class="btn btn-primary" style="height: 50px;">
                    <i class="bi bi-search"></i> Buscar
                </button>
            </div>
        </form>

        {% if erro_busca %}
        <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; color: #856404;">
            <i class="bi bi-exclamation-triangle"></i> {{ erro_busca }}
        </div>
        {% endif %}
    </div>

    <!-- Item Encontrado -->
    {% if item_encontrado %}
    <div class="detail-card" style="border: 2px solid #4CAF50;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
                <h2 style="color: #4CAF50; margin-bottom: 15px;">
                    <i class="bi bi-check-circle"></i> Ativo Encontrado
                </h2>
                
                <div class="detail-content">
                    <div class="detail-info">
                        <div class="detail-row">
                            <span class="detail-label">Etiqueta:</span>
                            <span class="detail-value"><strong style="font-size: 20px;">{{ item_encontrado.ativo.etiqueta }}</strong></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Nome:</span>
                            <span class="detail-value">{{ item_encontrado.ativo.nome }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Categoria:</span>
                            <span class="detail-value">{{ item_encontrado.ativo.categoria.nome|default:"-" }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Número de Série:</span>
                            <span class="detail-value">{{ item_encontrado.ativo.numero_serie|default:"-" }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Status Atual:</span>
                            <span class="detail-value">
                                {% if item_encontrado.verificado %}
                                    <span style="color: green;"><i class="bi bi-check-circle-fill"></i> Já Verificado</span>
                                {% else %}
                                    <span style="color: orange;"><i class="bi bi-clock"></i> Pendente</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>

                {% if not item_encontrado.verificado %}
                <!-- Formulário de Verificação -->
                <form method="post" id="verificacaoForm" style="margin-top: 20px;">
                    {% csrf_token %}
                    <h3 style="font-size: 16px; margin-bottom: 15px;">Informações da Verificação</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            {{ item_form.estado_fisico.label_tag }}
                            {{ item_form.estado_fisico }}
                        </div>
                        <div class="form-group">
                            {{ item_form.localizacao_real.label_tag }}
                            {{ item_form.localizacao_real }}
                        </div>
                        <div class="form-group full-width">
                            {{ item_form.observacao.label_tag }}
                            {{ item_form.observacao }}
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <button type="button" class="btn btn-primary" style="font-size: 18px; padding: 15px 30px;" onclick="verificarItem({{ item_encontrado.id }})">
                            <i class="bi bi-check-circle"></i> VERIFICAR ATIVO
                        </button>
                    </div>
                </form>
                {% else %}
                <div style="margin-top: 20px;">
                    <p style="color: #666;">Verificado em {{ item_encontrado.data_verificacao|date:"d/m/Y H:i" }} por {{ item_encontrado.verificado_por.get_full_name|default:item_encontrado.verificado_por.username }}</p>
                    <button type="button" class="btn btn-secondary" onclick="desverificarItem({{ item_encontrado.id }})">
                        <i class="bi bi-x-circle"></i> Remover Verificação
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Lista de Ativos Pendentes -->
    <div class="detail-card">
        <h2>Ativos Pendentes ({{ itens_pendentes.count }})</h2>
        
        {% if itens_pendentes %}
        <table class="table" style="margin-top: 20px;">
            <thead>
                <tr>
                    <th>Etiqueta</th>
                    <th>Nome</th>
                    <th>Categoria</th>
                    <th>Localização Cadastrada</th>
                </tr>
            </thead>
            <tbody>
                {% for item in itens_pendentes|slice:":20" %}
                <tr>
                    <td><strong>{{ item.ativo.etiqueta }}</strong></td>
                    <td>{{ item.ativo.nome }}</td>
                    <td>{{ item.ativo.categoria.nome|default:"-" }}</td>
                    <td>{{ item.ativo.localizacao.nome|default:"-" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if itens_pendentes.count > 20 %}
        <p style="text-align: center; color: #666; margin-top: 10px;">
            Mostrando 20 de {{ itens_pendentes.count }} ativos pendentes
        </p>
        {% endif %}
        {% else %}
        <p style="text-align: center; color: #4CAF50; padding: 30px; font-size: 18px;">
            <i class="bi bi-check-circle-fill"></i> Todos os ativos foram verificados!
        </p>
        <div style="text-align: center; margin-top: 20px;">
            <a href="{% url 'auditoria:auditoria_finalizar' auditoria.pk %}" class="btn btn-primary" style="font-size: 18px; padding: 15px 30px;">
                <i class="bi bi-flag-fill"></i> FINALIZAR AUDITORIA
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Auto-focus no campo de código
document.getElementById('codigo').focus();

// Limpa o campo após busca
{% if item_encontrado %}
document.getElementById('codigo').value = '';
document.getElementById('codigo').focus();
{% endif %}

// Função para verificar item
function verificarItem(itemId) {
    const form = document.getElementById('verificacaoForm');
    const formData = new FormData(form);
    
    fetch(`/auditoria/{{ auditoria.pk }}/verificar/${itemId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Mostra mensagem de sucesso
            alert('Ativo verificado com sucesso!');
            // Recarrega a página
            window.location.href = '{% url "auditoria:auditoria_executar" auditoria.pk %}';
        } else {
            alert('Erro ao verificar ativo: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao verificar ativo');
    });
}

// Função para desverificar item
function desverificarItem(itemId) {
    if (confirm('Deseja realmente remover a verificação deste ativo?')) {
        fetch(`/auditoria/{{ auditoria.pk }}/desverificar/${itemId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.href = '{% url "auditoria:auditoria_executar" auditoria.pk %}';
            } else {
                alert('Erro ao desverificar: ' + (data.message || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao desverificar ativo');
        });
    }
}

// Som de beep ao encontrar ativo (opcional)
{% if item_encontrado and not item_encontrado.verificado %}
const audioContext = new (window.AudioContext || window.webkitAudioContext)();
const oscillator = audioContext.createOscillator();
const gainNode = audioContext.createGain();
oscillator.connect(gainNode);
gainNode.connect(audioContext.destination);
oscillator.frequency.value = 800;
oscillator.type = 'sine';
gainNode.gain.value = 0.3;
oscillator.start(audioContext.currentTime);
oscillator.stop(audioContext.currentTime + 0.1);
{% endif %}
</script>
{% endblock %}