{% extends 'layouts/base.html' %}

{% block title %}Versões do Agente{% endblock %}

{% block conteudo %}
<div class="content">
    <!-- Cabeçalho -->
    <div class="page-header">
        <h1>Versões do Agente</h1>
        <a href="{% url 'inventario:version_create' %}" class="btn btn-primary">Nova Versão</a>
    </div>

    <!-- Estatísticas -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; text-align: center;">
            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Total de Versões</div>
            <div style="font-size: 32px; font-weight: bold; color: #333;">{{ total_versions }}</div>
        </div>

        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; text-align: center;">
            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Versões Ativas</div>
            <div style="font-size: 32px; font-weight: bold; color: #28a745;">{{ active_versions }}</div>
        </div>
    </div>

    <!-- Tabela de Versões -->
    <table class="table">
        <thead>
            <tr>
                <th>Versão</th>
                <th>Status</th>
                <th>Criado por</th>
                <th>Criado em</th>
                <th>Notas de Lançamento</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for version in versions %}
            <tr>
                <td><strong style="font-size: 16px;">v{{ version.version }}</strong></td>
                <td>
                    {% with status=version.get_status_display %}
                        {% if status.class == 'success' %}
                            <span style="color: green;">● {{ status.text }}</span>
                        {% elif status.class == 'danger' %}
                            <span style="color: red;">● {{ status.text }}</span>
                        {% elif status.class == 'secondary' %}
                            <span style="color: gray;">● {{ status.text }}</span>
                        {% endif %}
                    {% endwith %}
                </td>
                <td>{{ version.created_by.username }}</td>
                <td>{{ version.created_at|date:"d/m/Y H:i" }}</td>
                <td>
                    <a href="#" onclick="showNotes('{{ version.pk }}'); return false;" class="btn btn-sm btn-primary">
                        Ver Notas
                    </a>
                    <!-- Modal inline -->
                    <div id="notes-{{ version.pk }}" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
                        <div style="background: white; margin: 50px auto; padding: 30px; max-width: 800px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 style="margin: 0;">Notas de Lançamento - Versão {{ version.version }}</h2>
                                <button onclick="hideNotes('{{ version.pk }}')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
                            </div>
                            <div style="background: #f5f5f5; padding: 20px; border-radius: 4px; border: 1px solid #ddd;">
                                <pre style="margin: 0; white-space: pre-wrap; font-family: 'Segoe UI', sans-serif; font-size: 14px; line-height: 1.6;">{{ version.release_notes }}</pre>
                            </div>
                            <div style="margin-top: 20px; text-align: right;">
                                <button onclick="hideNotes('{{ version.pk }}')" class="btn btn-secondary">Fechar</button>
                            </div>
                        </div>
                    </div>
                </td>
                <td>
                    <form method="post" action="{% url 'inventario:version_toggle' version.pk %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm {% if version.is_active %}btn-warning{% else %}btn-success{% endif %}" title="{% if version.is_active %}Desativar{% else %}Ativar{% endif %}">
                            {% if version.is_active %}Desativar{% else %}Ativar{% endif %}
                        </button>
                    </form>
                    <a href="{{ version.file_path.url }}" class="btn btn-sm btn-primary" download title="Download">
                        Download
                    </a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="text-center" style="padding: 40px;">
                    <p style="color: #999; margin-bottom: 15px;">Nenhuma versão cadastrada ainda.</p>
                    <a href="{% url 'inventario:version_create' %}" class="btn btn-primary">Criar Primeira Versão</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Paginação -->
    {% if is_paginated %}
    <nav aria-label="Navegação de página">
        <ul class="pagination">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1">Primeira</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Anterior</a>
                </li>
            {% endif %}

            <li class="page-item active">
                <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
            </li>

            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">Próxima</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Última</a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    <!-- Informações -->
    <div class="detail-card">
        <h2>Sobre as Versões do Agente</h2>
        <div class="detail-content">
            <div class="detail-info">
                <div class="detail-row">
                    <span class="detail-label">Disponibilidade:</span>
                    <span class="detail-value">Apenas versões ativas estarão disponíveis para download pelos agentes</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Atualização:</span>
                    <span class="detail-value">A versão mais recente ativa será oferecida automaticamente aos agentes</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Obrigatória:</span>
                    <span class="detail-value">Versões marcadas como obrigatórias forçarão a atualização de todos os agentes</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Formato:</span>
                    <span class="detail-value">Use versionamento semântico: MAJOR.MINOR.PATCH (ex: 2.1.0)</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showNotes(id) {
    document.getElementById('notes-' + id).style.display = 'block';
}

function hideNotes(id) {
    document.getElementById('notes-' + id).style.display = 'none';
}

// Fechar modal ao clicar fora
document.addEventListener('click', function(e) {
    if (e.target.style && e.target.style.position === 'fixed') {
        e.target.style.display = 'none';
    }
});
</script>
{% endblock %}