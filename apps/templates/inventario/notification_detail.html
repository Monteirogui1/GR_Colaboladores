{% extends 'layouts/base.html' %}

{% block title %}{{ notification.title }} - TI Manager{% endblock %}

{% block conteudo %}
<div class="content">
    <!-- Cabeçalho -->
    <div class="page-header">
        <h1>{{ notification.title }}</h1>
        <div class="filter-buttons">
            {% if not notification.is_read %}
            <button onclick="markAsRead()" class="btn btn-primary">
                <i class="bi bi-check2"></i> Marcar como Lida
            </button>
            {% endif %}
            <button onclick="deleteNotification()" class="btn btn-delete">
                <i class="bi bi-trash"></i> Excluir
            </button>
            <a href="{% url 'inventario:notifications_list' %}" class="btn btn-secondary">Voltar</a>
        </div>
    </div>

    <!-- Card Principal -->
    <div class="detail-card" style="border-left: 4px solid 
        {% if notification.type == 'info' %}#2196F3
        {% elif notification.type == 'success' %}#4CAF50
        {% elif notification.type == 'warning' %}#FF9800
        {% elif notification.type == 'error' %}#F44336
        {% elif notification.type == 'alert' %}#FF5722
        {% elif notification.type == 'critical' %}#D32F2F
        {% else %}#9E9E9E{% endif %};">
        
        <div style="display: flex; align-items: start; gap: 20px; margin-bottom: 30px;">
            <div style="
                width: 80px; 
                height: 80px; 
                border-radius: 50%; 
                display: flex; 
                align-items: center; 
                justify-content: center;
                background: 
                {% if notification.type == 'info' %}rgba(33, 150, 243, 0.1)
                {% elif notification.type == 'success' %}rgba(76, 175, 80, 0.1)
                {% elif notification.type == 'warning' %}rgba(255, 152, 0, 0.1)
                {% elif notification.type == 'error' %}rgba(244, 67, 54, 0.1)
                {% elif notification.type == 'alert' %}rgba(255, 87, 34, 0.1)
                {% elif notification.type == 'critical' %}rgba(211, 47, 47, 0.1)
                {% else %}rgba(158, 158, 158, 0.1){% endif %};
            ">
                <i class="bi 
                    {% if notification.type == 'info' %}bi-info-circle
                    {% elif notification.type == 'success' %}bi-check-circle
                    {% elif notification.type == 'warning' %}bi-exclamation-triangle
                    {% elif notification.type == 'error' %}bi-x-circle
                    {% elif notification.type == 'alert' %}bi-bell
                    {% elif notification.type == 'critical' %}bi-exclamation-octagon
                    {% else %}bi-circle{% endif %}"
                    style="font-size: 40px; color: 
                    {% if notification.type == 'info' %}#2196F3
                    {% elif notification.type == 'success' %}#4CAF50
                    {% elif notification.type == 'warning' %}#FF9800
                    {% elif notification.type == 'error' %}#F44336
                    {% elif notification.type == 'alert' %}#FF5722
                    {% elif notification.type == 'critical' %}#D32F2F
                    {% else %}#9E9E9E{% endif %};"></i>
            </div>
            
            <div style="flex: 1;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <span style="
                        padding: 4px 12px; 
                        border-radius: 12px; 
                        font-size: 12px; 
                        font-weight: 500;
                        background: 
                        {% if notification.type == 'info' %}#2196F3
                        {% elif notification.type == 'success' %}#4CAF50
                        {% elif notification.type == 'warning' %}#FF9800
                        {% elif notification.type == 'error' %}#F44336
                        {% elif notification.type == 'alert' %}#FF5722
                        {% elif notification.type == 'critical' %}#D32F2F
                        {% else %}#9E9E9E{% endif %};
                        color: white;
                    ">{{ notification.get_type_display }}</span>
                    
                    <span style="
                        padding: 4px 12px; 
                        border-radius: 12px; 
                        font-size: 12px; 
                        font-weight: 500;
                        background: 
                        {% if notification.priority == 'low' %}#9E9E9E
                        {% elif notification.priority == 'normal' %}#2196F3
                        {% elif notification.priority == 'high' %}#FF9800
                        {% elif notification.priority == 'critical' %}#F44336
                        {% else %}#9E9E9E{% endif %};
                        color: white;
                    ">{{ notification.get_priority_display }}</span>
                    
                    {% if notification.is_read %}
                    <span style="background: #4CAF50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                        <i class="bi bi-check2"></i> Lida
                    </span>
                    {% else %}
                    <span style="background: #FF9800; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                        <i class="bi bi-circle-fill"></i> Não Lida
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Mensagem -->
        <h2>Mensagem</h2>
        <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 30px;">
            <p style="margin: 0; white-space: pre-wrap; line-height: 1.6;">{{ notification.message }}</p>
        </div>

        <!-- Informações em Grid -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <!-- Máquina Destinatária -->
            <div>
                <h2>Máquina Destinatária</h2>
                <div class="detail-info">
                    <div class="detail-row">
                        <span class="detail-label"><i class="bi bi-laptop"></i> Hostname:</span>
                        <span class="detail-value">{{ notification.machine.hostname }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label"><i class="bi bi-hdd-network"></i> IP:</span>
                        <span class="detail-value">{{ notification.machine.ip_address|default:"N/A" }}</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <a href="{% url 'inventario:machine_detail' notification.machine.pk %}" class="btn btn-primary">
                            <i class="bi bi-box-arrow-up-right"></i> Ver Máquina
                        </a>
                    </div>
                </div>
            </div>

            <!-- Detalhes da Notificação -->
            <div>
                <h2>Detalhes</h2>
                <div class="detail-info">
                    <div class="detail-row">
                        <span class="detail-label"><i class="bi bi-calendar-event"></i> Criada em:</span>
                        <span class="detail-value">{{ notification.created_at|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% if notification.is_read %}
                    <div class="detail-row">
                        <span class="detail-label"><i class="bi bi-check2-circle"></i> Lida em:</span>
                        <span class="detail-value">{{ notification.read_at|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% endif %}
                    {% if notification.expires_at %}
                    <div class="detail-row">
                        <span class="detail-label"><i class="bi bi-clock-history"></i> Expira em:</span>
                        <span class="detail-value">
                            {{ notification.expires_at|date:"d/m/Y H:i" }}
                            {% if notification.is_expired %}
                                <span style="color: #F44336; font-weight: 500;"> (Expirada)</span>
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}
                    <div class="detail-row">
                        <span class="detail-label"><i class="bi bi-hourglass-split"></i> Idade:</span>
                        <span class="detail-value">{{ notification.created_at|timesince }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label"><i class="bi bi-gear"></i> Status:</span>
                        <span class="detail-value">
                            <span style="color: 
                                {% if notification.status == 'pending' %}#FF9800
                                {% elif notification.status == 'read' %}#4CAF50
                                {% elif notification.status == 'expired' %}#9E9E9E
                                {% else %}#666{% endif %};">
                                ● {{ notification.get_status_display }}
                            </span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline -->
    <div class="detail-card">
        <h2>Histórico</h2>
        <div style="margin-top: 20px;">
            <div style="border-left: 2px solid #e0e0e0; padding-left: 20px; position: relative;">
                <div style="position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: #2196F3; border: 3px solid white;"></div>
                <div style="margin-bottom: 30px;">
                    <strong>Notificação Criada</strong>
                    <div style="color: #999; font-size: 14px;">{{ notification.created_at|date:"d/m/Y H:i:s" }}</div>
                </div>

                {% if notification.is_read %}
                <div style="position: absolute; left: -9px; top: 60px; width: 16px; height: 16px; border-radius: 50%; background: #4CAF50; border: 3px solid white;"></div>
                <div style="margin-bottom: 30px; padding-top: 30px;">
                    <strong>Notificação Lida</strong>
                    <div style="color: #999; font-size: 14px;">{{ notification.read_at|date:"d/m/Y H:i:s" }}</div>
                </div>
                {% endif %}

                {% if notification.status == 'expired' %}
                <div style="position: absolute; left: -9px; top: 120px; width: 16px; height: 16px; border-radius: 50%; background: #9E9E9E; border: 3px solid white;"></div>
                <div style="padding-top: 30px;">
                    <strong>Notificação Expirada</strong>
                    <div style="color: #999; font-size: 14px;">{{ notification.expires_at|date:"d/m/Y H:i:s" }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function deleteNotification() {
    if (confirm('Tem certeza que deseja excluir esta notificação?')) {
        fetch('{% url "inventario:notification_delete" notification.pk %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.href = data.redirect;
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao excluir notificação');
        });
    }
}

function markAsRead() {
    fetch('/api/notifications/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            notification_id: {{ notification.id }}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao marcar como lida');
    });
}
</script>
{% endblock %}